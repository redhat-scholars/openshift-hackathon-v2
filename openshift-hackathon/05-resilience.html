<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Openshift Hackathon</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/openshift-hackathon-v2/openshift-hackathon/05-resilience.html">
    <link rel="prev" href="04-observability.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/openshift-hackathon-v2">Openshift Hackathon</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="openshift-hackathon" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="00-prerequis.html">0. Pré-requis</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-containers.html">1. Challenge 1 - Containers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-openshift.html">2. Challenge 2 - OpenShift &amp; CI/CD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-helm_services.html">3. Challenge 3 - Helm et Services</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-observability.html">4. Challenge 4 - Observabilité</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="05-resilience.html">5. Challenge 5 - Résilience et scalabilité</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Openshift Hackathon</a></li>
    <li><a href="05-resilience.html">5. Challenge 5 - Résilience et scalabilité</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/openshift-hackathon-v2/edit/master/documentation/modules/ROOT/pages/05-resilience.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_résilience_et_scalabilité"><a class="anchor" href="#_résilience_et_scalabilité"></a>Résilience et scalabilité</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exercice1"><a class="anchor" href="#exercice1"></a>[<strong>Challenge 5.1</strong>]  Résilience et scalabilité <em>Beginner</em></h3>
<div class="paragraph">
<p>L&#8217;application <code>antennas-incident</code> a 2 endpoints qui fournissent des health checks :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>q/health/live</code> pour le liveness probe</p>
</li>
<li>
<p><code>q/health/ready</code> pour le readiness probe</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il va falloir mettre à jour les resources K8s afin d&#8217;utiliser ces probes.</p>
</div>
<div class="paragraph">
<p>Ensuite, il faut mettre en place un HPA (Horizontal Pod Autoscaler).
Mettez des valeurs assez basses pour faire réagir simplement le HPA.</p>
</div>
<div class="paragraph">
<p>Voici un exemple d&#8217;un HPA :</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">kind: HorizontalPodAutoscaler
apiVersion: autoscaling/v2beta2
metadata:
  name: example
  namespace: myspace
spec:
  scaleTargetRef:
    kind: Deployment
    name: mydeployment
    apiVersion: apps/v1
  minReplicas: 1
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: AverageValue
          averageValue: 15m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Voilà un exemple de commande permettant de stresser un peu notre backend afin de faire réagir le HPA:
<code>oc run stresspod --restart=Never  --image registry.access.redhat.com/ubi8/ubi-minimal --command&#8201;&#8212;&#8201;sh -c "while :; do curl 'http://&lt;antennas-incident service name&gt;/rest/incidents?api_key=&lt;votre secret&gt;' ; done"</code></p>
</div>
<div class="paragraph">
<p>Après quelques secondes, vous devriez avoir plusieurs PODs.</p>
</div>
<div class="sect3">
<h4 id="_preuves_à_fournir"><a class="anchor" href="#_preuves_à_fournir"></a>Preuves à fournir</h4>
<div class="ulist">
<ul>
<li>
<p>[<strong>Challenge 5.1.1</strong>] Screenshot ou manifest yaml du déploiement d&#8217;antennas-incident montrant les <code>readinessProbe</code> et <code>livenessProbe</code></p>
</li>
<li>
<p>[<strong>Challenge 5.1.2</strong>] Screenshot de la console faisant apparaître "Autoscaled to &#8230;&#8203;" ou manifest yaml du HPA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pensez à supprimer le POD "stresspod" si besoin (<code>oc delete po/stresspod</code>) : après quelques minutes, le HPA devrait réduite le nombre de PODs.</p>
</div>
<div class="paragraph">
<p><strong>Notes</strong> : nous avons utilisé ici la fonctionnalité "HorizontalPodAutoscaler" qui permet d&#8217;ajuster notre nombre de PODs dynamiquement.
Il existe également le "VerticalPodAutoscaler" (<a href="https://docs.openshift.com/container-platform/4.8/nodes/pods/nodes-pods-vertical-autoscaler.html" class="bare">https://docs.openshift.com/container-platform/4.8/nodes/pods/nodes-pods-vertical-autoscaler.html</a>) qui permet de modifier dynamiquement les ressources affectées à des PODs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exercice2"><a class="anchor" href="#exercice2"></a>[<strong>Challenge 5.2</strong>] Chaos Kube <em>Advanced</em></h3>
<div class="sect3">
<h4 id="_chaos_testing_with_chaoskube_introduction"><a class="anchor" href="#_chaos_testing_with_chaoskube_introduction"></a>Chaos testing with chaoskube - Introduction</h4>
<div class="paragraph">
<p>GitHub repository du projet: <a href="https://github.com/linki/chaoskube/" class="bare">https://github.com/linki/chaoskube/</a></p>
</div>
<div class="paragraph">
<p>Le principe est de mettre en place un outil qui va nous permettre de
simuler des pannes aléatoires sur un projet afin d’améliorer la
résistance des applications pour surmonter ces pannes en utilisant des
fonctionnalités de kubernetes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installation_de_chaoskube"><a class="anchor" href="#_installation_de_chaoskube"></a>Installation de chaoskube</h4>
<div class="sect4">
<h5 id="_préambule"><a class="anchor" href="#_préambule"></a>Préambule</h5>
<div class="paragraph">
<p>OpenShift impose un certain nombre de restrictions liées à la sécurité
qui n&#8217;exitent pas sur d&#8217;autres environements kubernetes.</p>
</div>
<div class="paragraph">
<p>Par example, sur OpenShift les SCCs (Security Context Constraints) ajoute un niveau
de sécurité supplémentaire au cluster kubernetes en restreignant les droits alloués
aux comptes de services en charge de l&#8217;execution des containers.</p>
</div>
<div class="paragraph">
<p>OpenShift fait également attention à assigner des user ids uniques par pod au sein
d&#8217;un même projet.</p>
</div>
<div class="paragraph">
<p>Cependant, ce niveau de sécurité plus élevé demande parfois de réaliser quelques
modifications et un peu d’adaptation pour pouvoir
deployer des applications qui n’ont pas encore été testées sur OpenShift. À
noter que ça n’est pas réciproque, une application packagée et testée
pour OpenShift se déploiera généralement sans modification sur une
autre distribution kubernetes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-project chaoskube
oc adm policy add-scc-to-user runasanyuid -z chaoskube
cat &lt;&lt;-EOF &gt; values-override.yaml
podSecurityContext:
   runAsUser:
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Dans le cas présent, on remplace les valeurs de configurations par défaut dans le template helm en créant un fichier values-override.yaml.</p>
</div>
<div class="paragraph">
<p>Vous pouvez également attribuer une SCC au compte de service chaoskube (anyuid ou runasanyuid en fonction de la version d&#8217;OpenShift) pour palier à ce problème.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc adm policy add-scc-to-user anyuid -z chaoskube</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ou bien, créer un fork du repository git chaoskube, faire la modification dans votre repository et soumettre une pull request aux développeurs de chaoskube.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_déploiement_helm"><a class="anchor" href="#_déploiement_helm"></a>Déploiement Helm</h5>
<div class="paragraph">
<p>Ensuite, procéder à l’installation comme spécifié dans la documentation
en omettant de créer le namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm repo add chaoskube https://linki.github.io/chaoskube/
helm install chaoskube chaoskube/chaoskube --atomic --namespace=chaoskube -f ./values-override.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vérifier le bon déploiement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">$ oc -n chaoskube get pods
NAME                        READY   STATUS    RESTARTS   AGE
chaoskube-b88449d95-zfbv7   1/1     Running   0          6s

$ oc -n chaoskube logs -f $(oc -n chaoskube get pods -l app.kubernetes.io/instance=chaoskube -oname)
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_cleanup"><a class="anchor" href="#_cleanup"></a>Cleanup</h5>
<div class="paragraph">
<p>Chaoskube devrait être déployé et fonctionnel. Cependant, nous
souhaitons le paramétrer pour ne cibler que des applications spécifiques
et à une fréquence différente.</p>
</div>
<div class="paragraph">
<p>Pour consulter les paramètres de configuration disponibles, vous pouvez
lire la documentation mais également les consulter de la façon suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n chaoskube exec -ti  $(oc -n chaoskube get pods -l app.kubernetes.io/instance=chaoskube -oname) --  /usr/local/bin/chaoskube --help
usage: chaoskube [&lt;flags&gt;]

Flags:
  --help                         Show context-sensitive help (also try --help-long and --help-man).
  --labels=LABELS                A set of labels to restrict the list of affected pods. Defaults to everything.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour supprimer le déploiement de chaoskube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm uninstall chaoskube</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note</em>: un chart helm peut être configuré en utilisant un fichier
values.yaml ou values-override.yaml (voir le déploiement initial)
qui remplace les paramètres définis par défaut.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercice"><a class="anchor" href="#_exercice"></a>[<strong>Exercice</strong>]</h4>
<div class="paragraph">
<p>En partant d’un déploiement simple, utiliser chaoskube pour tester la
résilience de cette application:
* cibler exclusivement le namespace de l’application
* tuer des ressources toutes les 15 secondes
* s&#8217;assurer que les pods sont bien détruits dans le namespace ciblé</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: chaoskube-test
  name: chaoskube-test
  namespace: chaoskube-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: chaoskube-test
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: chaoskube-test
    spec:
      containers:
      - command:
        - /bin/sh
        - -c
        - sleep INF
        image: quay.io/xymox/ubi8-debug-toolkit:latest
        name: ubi8-debug-toolkit
        resources: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
status: {}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Vous pouvez modifier les paramètres de ce descripteur de déploiement pour augmenter la disponibilité de l’application
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preuves_à_fournir_2"><a class="anchor" href="#_preuves_à_fournir_2"></a>Preuves à fournir</h4>
<div class="ulist">
<ul>
<li>
<p>[<strong>Challenge 5.2.1</strong>] fichier values-override.yaml + extrait des logs chaoskube prouvant la destruction de pods dans l’intervalle de temps défini</p>
</li>
<li>
<p>[<strong>Challenge 5.2.2</strong>] Output des pods applicatifs incluant leur statut et leur âge démontrant la disponibilité de l’application malgré les destructions aléatoires</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bonus_challenge_antenna_front_chaos"><a class="anchor" href="#_bonus_challenge_antenna_front_chaos"></a>BONUS challenge - Antenna Front chaos</h3>
<div class="paragraph">
<p>En utilisant le projet antenna-front, configurez chaoskube pour y
appliquer le chaos testing.</p>
</div>
<div class="sect3">
<h4 id="_preuves_à_fournir_3"><a class="anchor" href="#_preuves_à_fournir_3"></a>Preuves à fournir</h4>
<div class="ulist">
<ul>
<li>
<p>[<strong>Challenge 5.2.3</strong>] logs chaoskube prouvant la destruction de pods dans l’intervalle de temps défini plus évidences du test de l’API (http) pendant 2 minutes affichant son taux de disponibilité (script utilisé + résultats)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-observability.html">4. Challenge 4 - Observabilité</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
